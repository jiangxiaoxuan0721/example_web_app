<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重构验证 - N-1仿真向导</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-section h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        .test-item {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .test-item.success {
            background: #d4edda;
            border-left: 4px solid #28a745;
        }
        .test-item.error {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
        }
        .test-item.warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
        }
        .status-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-right: 10px;
            vertical-align: middle;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            text-decoration: none;
            display: inline-block;
            color: white;
        }
        .btn-primary {
            background: #007bff;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-secondary {
            background: #6c757d;
        }
        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
        }
        code {
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: #e7f3ff;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>N-1仿真向导重构验证</h1>
        <p class="subtitle">验证重构后的动态渲染系统是否正常工作</p>

        <div id="testResults"></div>

        <div class="summary">
            <h3>验证总结</h3>
            <p id="summaryText">正在执行验证测试...</p>
        </div>

        <div style="margin-top: 30px;">
            <a href="/pages/n1_wizard/wizard_entry.html" class="btn btn-primary">返回向导入口</a>
            <a href="/pages/n1_wizard/steps/wizard_template.html?mode=single&step=0" class="btn btn-success">测试单次仿真向导</a>
            <a href="/pages/n1_wizard/steps/wizard_template.html?mode=batch&step=0" class="btn btn-secondary">测试批量仿真向导</a>
        </div>
    </div>

    <script>
        async function runTests() {
            const resultsContainer = document.getElementById('testResults');
            const summaryText = document.getElementById('summaryText');
            let passedTests = 0;
            let totalTests = 0;

            function addTestResult(name, status, message, details = null) {
                totalTests++;
                if (status === 'success') passedTests++;
                
                const testItem = document.createElement('div');
                testItem.className = `test-item ${status}`;
                
                const icon = status === 'success' ? '✓' : status === 'error' ? '✗' : '⚠';
                testItem.innerHTML = `
                    <span class="status-icon">${icon}</span>
                    <strong>${name}</strong>: ${message}
                    ${details ? `<pre><code>${JSON.stringify(details, null, 2)}</code></pre>` : ''}
                `;
                
                resultsContainer.appendChild(testItem);
            }

            // 测试1: 检查配置文件是否存在
            try {
                const configResponse = await fetch('/pages/n1_wizard/config/wizard_config.json');
                if (configResponse.ok) {
                    const config = await configResponse.json();
                    addTestResult('配置文件加载', 'success', 'wizard_config.json 文件存在且格式正确');
                    
                    // 测试2: 检查配置结构
                    if (config.modes && config.modes.single && config.modes.batch) {
                        addTestResult('配置结构', 'success', '配置包含 single 和 batch 两种模式');
                    } else {
                        addTestResult('配置结构', 'error', '配置缺少必要的模式定义');
                    }
                    
                    // 测试3: 检查步骤数量
                    if (config.modes.single.steps.length === 8) {
                        addTestResult('单次仿真步骤', 'success', '单次仿真模式包含8个步骤');
                    } else {
                        addTestResult('单次仿真步骤', 'error', `单次仿真模式应包含8个步骤，实际有${config.modes.single.steps.length}个`);
                    }
                    
                    if (config.modes.batch.steps.length === 6) {
                        addTestResult('批量仿真步骤', 'success', '批量仿真模式包含6个步骤');
                    } else {
                        addTestResult('批量仿真步骤', 'error', `批量仿真模式应包含6个步骤，实际有${config.modes.batch.steps.length}个`);
                    }
                    
                    // 测试4: 检查组件定义
                    if (config.components && Object.keys(config.components).length > 0) {
                        addTestResult('组件定义', 'success', `定义了${Object.keys(config.components).length}种组件类型`);
                    } else {
                        addTestResult('组件定义', 'error', '缺少组件定义');
                    }
                    
                    // 测试5: 检查步骤完整性
                    let allStepsValid = true;
                    [...config.modes.single.steps, ...config.modes.batch.steps].forEach((step, index) => {
                        if (!step.id || !step.title || !step.description || !step.component || !step.executionStrategy || !step.nextAction) {
                            allStepsValid = false;
                            addTestResult(`步骤完整性 (${step.title || index})`, 'error', '步骤缺少必要的字段');
                        }
                    });
                    
                    if (allStepsValid) {
                        addTestResult('步骤完整性', 'success', '所有步骤都包含必要的字段');
                    }
                } else {
                    addTestResult('配置文件加载', 'error', `无法加载配置文件: ${configResponse.status}`);
                }
            } catch (error) {
                addTestResult('配置文件加载', 'error', `加载配置文件时出错: ${error.message}`);
            }

            // 测试6: 检查内容管理器
            try {
                const response = await fetch('/pages/n1_wizard/shared/step_content_manager.js');
                if (response.ok) {
                    addTestResult('内容管理器', 'success', 'step_content_manager.js 文件存在');
                } else {
                    addTestResult('内容管理器', 'error', `无法加载内容管理器: ${response.status}`);
                }
            } catch (error) {
                addTestResult('内容管理器', 'error', `加载内容管理器时出错: ${error.message}`);
            }

            // 测试7: 检查模板文件
            try {
                const response = await fetch('/pages/n1_wizard/steps/wizard_template.html');
                if (response.ok) {
                    const content = await response.text();
                    if (content.includes('step_content_manager.js')) {
                        addTestResult('模板文件', 'success', 'wizard_template.html 已集成内容管理器');
                    } else {
                        addTestResult('模板文件', 'error', '模板文件未正确集成内容管理器');
                    }
                } else {
                    addTestResult('模板文件', 'error', `无法加载模板文件: ${response.status}`);
                }
            } catch (error) {
                addTestResult('模板文件', 'error', `加载模板文件时出错: ${error.message}`);
            }

            // 测试8: 检查导航管理器
            try {
                const response = await fetch('/pages/n1_wizard/shared/navigation.js');
                if (response.ok) {
                    addTestResult('导航管理器', 'success', 'navigation.js 文件存在且可访问');
                } else {
                    addTestResult('导航管理器', 'error', `无法加载导航管理器: ${response.status}`);
                }
            } catch (error) {
                addTestResult('导航管理器', 'error', `加载导航管理器时出错: ${error.message}`);
            }

            // 测试9: 检查样式文件
            try {
                const response = await fetch('/pages/n1_wizard/n1_wizard.css');
                if (response.ok) {
                    addTestResult('样式文件', 'success', 'n1_wizard.css 文件存在且可访问');
                } else {
                    addTestResult('样式文件', 'error', `无法加载样式文件: ${response.status}`);
                }
            } catch (error) {
                addTestResult('样式文件', 'error', `加载样式文件时出错: ${error.message}`);
            }

            // 测试10: 检查旧文件是否已删除
            try {
                const checkFile = async (path) => {
                    try {
                        const response = await fetch(path);
                        return response.ok;
                    } catch {
                        return false;
                    }
                };
                
                const oldFiles = [
                    '/pages/n1_wizard/steps/single_mode/step_0.html',
                    '/pages/n1_wizard/steps/single_mode/step_0.js',
                    '/pages/n1_wizard/steps/batch_mode/step_0.html',
                    '/pages/n1_wizard/steps/batch_mode/step_0.js'
                ];
                
                const oldFilesExist = await Promise.all(oldFiles.map(checkFile));
                if (oldFilesExist.some(exists => exists)) {
                    addTestResult('旧文件清理', 'warning', '部分旧文件可能仍然存在，建议检查并删除');
                } else {
                    addTestResult('旧文件清理', 'success', '旧文件已正确清理');
                }
            } catch (error) {
                addTestResult('旧文件清理', 'error', `检查旧文件时出错: ${error.message}`);
            }

            // 更新总结
            summaryText.textContent = `验证完成！通过 ${passedTests}/${totalTests} 项测试。`;
            if (passedTests === totalTests) {
                summaryText.style.color = '#28a745';
                summaryText.textContent += ' 重构成功，系统可以正常使用！';
            } else if (passedTests >= totalTests * 0.8) {
                summaryText.style.color = '#ffc107';
                summaryText.textContent += ' 大部分功能正常，建议检查失败的测试项。';
            } else {
                summaryText.style.color = '#dc3545';
                summaryText.textContent += ' 存在严重问题，需要修复。';
            }
        }

        // 运行测试
        runTests().catch(error => {
            document.getElementById('testResults').innerHTML = `
                <div class="test-item error">
                    <span class="status-icon">✗</span>
                    <strong>严重错误</strong>: 执行测试时发生错误
                    <pre><code>${error.message}\n${error.stack}</code></pre>
                </div>
            `;
        });
    </script>
</body>
</html>
