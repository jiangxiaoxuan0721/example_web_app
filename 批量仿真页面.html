<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ N-1 ç¨³å®šæ€§åˆ†ææŠ¥å‘Š (Enhanced Layout)</title>
    <style>
        :root {
            --primary-color: #1890ff;
            --success-color: #52c41a;
            --warning-color: #faad14;
            --error-color: #f5222d;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-secondary: #666;
            --border-color: #e8e8e8;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: var(--text-main); }
        .container { max-width: 1400px; margin: 0 auto; }
        
        /* é¡¶éƒ¨çœ‹æ¿ */
        .header { margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; margin: 0; }
        .batch-info { color: var(--text-secondary); font-size: 14px; margin-top: 5px; display: block; }
        .kpi-board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
        .kpi-card { background: var(--card-bg); padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.3s; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .kpi-title { font-size: 14px; color: var(--text-secondary); margin-bottom: 8px; }
        .kpi-value { font-size: 28px; font-weight: bold; }
        .kpi-value.error { color: var(--error-color); }
        .kpi-value.warning { color: var(--warning-color); }
        
        /* ä¸»æ•°æ®è¡¨æ ¼åŒº */
        .main-card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* å·¥å…·æ æ”¹è¿› */
        .toolbar { padding: 16px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .search-input { padding: 6px 10px; border: 1px solid #d9d9d9; border-radius: 4px; width: 220px; outline: none; transition: border 0.3s; height: 32px; box-sizing: border-box;}
        .search-input:focus { border-color: var(--primary-color); }
        
        .btn { padding: 5px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; transition: 0.2s; height: 32px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-primary:hover { background: #40a9ff; }
        
        /* ç­›é€‰æŒ‰é’®ç»„æ ·å¼ */
        .btn-filter { background: #fff; border: 1px solid #d9d9d9; color: var(--text-main); user-select: none; }
        .btn-filter:hover { border-color: var(--primary-color); color: var(--primary-color); }
        
        /* æ¿€æ´»çŠ¶æ€ - é€šç”¨å¼‚å¸¸ */
        .btn-filter[data-active="true"] { background: var(--text-main); border-color: var(--text-main); color: white; }
        
        /* æ¿€æ´»çŠ¶æ€ - å…·ä½“ç±»å‹ (çº¢è‰²ç³») */
        .btn-filter.type-error[data-active="true"] { background: var(--error-color); border-color: var(--error-color); color: white; }
        /* æ¿€æ´»çŠ¶æ€ - å…·ä½“ç±»å‹ (æ©™è‰²ç³») */
        .btn-filter.type-warning[data-active="true"] { background: var(--warning-color); border-color: var(--warning-color); color: white; }


        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        th { background: #fafafa; font-weight: 600; color: var(--text-secondary); }
        tr:hover { background: #e6f7ff; cursor: pointer; }
        
        /* çŠ¶æ€æ ‡ç­¾ */
        .tag { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .tag-success { background: #f6ffed; color: var(--success-color); border: 1px solid #b7eb8f; }
        .tag-error { background: #fff1f0; color: var(--error-color); border: 1px solid #ffa39e; }
        .tag-warning { background: #fffbe6; color: var(--warning-color); border: 1px solid #ffe58f; }

        /* ä¾§è¾¹è¯¦æƒ…æŠ½å±‰ */
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 100; backdrop-filter: blur(2px); }
        .drawer { position: fixed; top: 0; right: -900px; width: 900px; height: 100%; background: white; box-shadow: -4px 0 16px rgba(0,0,0,0.15); transition: right 0.3s cubic-bezier(0.23, 1, 0.32, 1); z-index: 101; display: flex; flex-direction: column; }
        .drawer.open { right: 0; }
        .drawer-overlay.open { display: block; }
        .drawer-header { padding: 20px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #fafafa; }
        .drawer-body { padding: 24px; overflow-y: auto; flex: 1; }
        .detail-section { margin-bottom: 32px; }
        .section-title { font-size: 16px; font-weight: bold; margin-bottom: 16px; border-left: 4px solid var(--primary-color); padding-left: 10px; color: #262626; }
        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; background: #f9f9f9; padding: 20px; border-radius: 6px; border: 1px solid #f0f0f0; }
        .info-item label { color: var(--text-secondary); font-size: 12px; display: block; margin-bottom: 6px; }
        .info-item span { font-weight: 500; font-size: 14px; color: #262626; }
        
        /* æ³¢å½¢å›¾æ ·å¼æ›´æ–° 
           1. æ”¹ä¸ºå•åˆ— (grid-template-columns: 1fr)
           2. å¢åŠ é«˜åº¦ (320px)
        */
        .img-grid { 
            display: grid; 
            grid-template-columns: 1fr; /* å•åˆ—å¸ƒå±€ */
            gap: 24px; 
        } 
        .chart-placeholder { background: #fff; border: 1px solid #e8e8e8; border-radius: 8px; padding: 16px; }
        .chart-title { font-size: 14px; font-weight: 600; margin-bottom: 12px; display: block; color: #595959; border-left: 3px solid #bfbfbf; padding-left: 8px; }
        .chart-container { 
            height: 320px; /* å¢åŠ é«˜åº¦ï¼Œä½¿å¤§å›¾æ›´æ¸…æ™° */
            background: #f5f5f5; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 4px; 
            overflow: hidden;
            position: relative;
            border: 1px solid #eee;
        }
        .chart-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            background: white;
            transition: transform 0.3s;
        }
        .chart-container img:hover { transform: scale(1.02); cursor: zoom-in; }
        
        /* æ–‡ä»¶åˆ—è¡¨ */
        .file-list-table { width: 100%; border-collapse: collapse; font-size: 13px; border: 1px solid #e8e8e8; }
        .file-list-table th, .file-list-table td { padding: 12px; border: 1px solid #e8e8e8; text-align: left; }
        .file-list-table th { background-color: #fafafa; }
        .download-btn {
            display: inline-flex; align-items: center; gap: 6px;
            color: var(--primary-color); text-decoration: none; font-weight: 500;
            padding: 4px 8px; border-radius: 4px; transition: background 0.2s;
        }
        .download-btn:hover { background: #e6f7ff; }

        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; transition: color 0.3s; }
        .close-btn:hover { color: #333; }
        
        .text-error { color: var(--error-color); font-weight: bold; }
        .text-warning { color: var(--warning-color); font-weight: bold; }
        
        /* è¾…åŠ©åˆ†å‰²çº¿ */
        .v-divider { width: 1px; height: 20px; background: #e8e8e8; margin: 0 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>Batch N-1 ç¨³å®šæ€§åˆ†ææŠ¥å‘Š</h1>
            <span class="batch-info" id="report-meta">ç”Ÿæˆæ—¶é—´: -- | ä»»åŠ¡ID: --</span>
        </div>
        <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ å¯¼å‡ºæŠ¥å‘Š/æ‰“å°</button>
    </div>

    <div class="kpi-board">
        <div class="kpi-card">
            <div class="kpi-title">ä»¿çœŸæ€»å·¥å†µæ•°</div>
            <div class="kpi-value" id="kpi-total">--</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">ç”µå‹ç¨³å®šæ€§å¼‚å¸¸</div>
            <div class="kpi-value error" id="kpi-volt">--</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">é¢‘ç‡ç¨³å®šæ€§å¼‚å¸¸</div>
            <div class="kpi-value warning" id="kpi-freq">--</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-title">åŠŸè§’ç¨³å®šæ€§å¼‚å¸¸</div>
            <div class="kpi-value error" id="kpi-angle">--</div>
        </div>
    </div>

    <div class="main-card">
        <div class="toolbar">
            <input type="text" class="search-input" id="search-box" placeholder="æœç´¢è®¾å¤‡ID..." onkeyup="applyFilter()">
            
            <div class="v-divider"></div>

            <button class="btn btn-filter" id="filter-unstable" onclick="toggleFilter('unstable')">
                âš ï¸ æ‰€æœ‰å¼‚å¸¸
            </button>
            <button class="btn btn-filter type-error" id="filter-volt" onclick="toggleFilter('volt')">
                âš¡ ç”µå‹è¶Šé™
            </button>
            <button class="btn btn-filter type-warning" id="filter-freq" onclick="toggleFilter('freq')">
                ğŸ“‰ é¢‘ç‡å¤±ç¨³
            </button>
            <button class="btn btn-filter type-error" id="filter-angle" onclick="toggleFilter('angle')">
                ğŸ“ åŠŸè§’å¤±ç¨³
            </button>
            
            <div style="margin-left: auto; font-size: 13px; color: #999;">ç‚¹å‡»è¡ŒæŸ¥çœ‹è¯¦æƒ…</div>
        </div>
        <table>
            <thead>
                <tr>
                    <th style="width: 15%">Case ID (TransKey)</th>
                    <th style="width: 10%">æ•…éšœç±»å‹</th>
                    <th style="width: 12%">æœ€ä½ç”µå‹</th>
                    <th style="width: 12%">æœ€å¤§é¢‘å</th>
                    <th style="width: 12%">æœ€å¤§åŠŸè§’å·®</th>
                    <th style="width: 25%">ç¨³å®šæ€§ç»“è®º</th>
                    <th style="width: 8%">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>
        <div id="empty-state" style="padding: 40px; text-align: center; color: #999; display: none;">
            æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®
        </div>
    </div>
</div>

<div class="drawer-overlay" id="overlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
    <div class="drawer-header">
        <div>
            <h2 style="margin:0; font-size:18px;" id="d-title">Case Detail</h2>
            <div id="d-status-tags" style="margin-top: 8px;"></div>
        </div>
        <button class="close-btn" onclick="closeDrawer()">Ã—</button>
    </div>
    <div class="drawer-body">
        
        <div class="detail-section">
            <div class="section-title">æ•…éšœåœºæ™¯å®šä¹‰</div>
            <div class="info-grid">
                <div class="info-item"><label>è®¾å¤‡æ ‡è¯† (TransKey)</label><span id="d-key">--</span></div>
                <div class="info-item"><label>æ•…éšœç±»å‹</label><span id="d-type">--</span></div>
                <div class="info-item"><label>æ•…éšœå¼€å§‹æ—¶é—´</label><span id="d-start-time">--</span> s</div>
                <div class="info-item"><label>æ•…éšœåˆ‡é™¤æ—¶é—´</label><span id="d-cut-time">--</span> s</div>
            </div>
        </div>

        <div class="detail-section">
            <div class="section-title">å…³é”®ç¨³å®šæ€§æŒ‡æ ‡ (KPIs)</div>
            <div class="info-grid" style="background: #fffbe6; border-color: #ffe58f;">
                <div class="info-item"><label>æ¯çº¿æœ€ä½ç”µå‹ (Min Voltage)</label><span id="d-volt">--</span></div>
                <div class="info-item"><label>æœ€å¤§é¢‘ç‡åç§» (Max Freq Dev)</label><span id="d-freq">--</span></div>
                <div class="info-item"><label>å‘ç”µæœºæœ€å¤§åŠŸè§’å·® (Max Angle Diff)</label><span id="d-angle">--</span></div>
                <div class="info-item"><label>ç»¼åˆåˆ¤å®š</label><span id="d-conclusion">--</span></div>
            </div>
        </div>

        <div class="detail-section">
            <div class="section-title">ä»¿çœŸæ³¢å½¢åˆ†æ</div>
            <div class="img-grid">
                <div class="chart-placeholder">
                    <span class="chart-title">å›¾1: å‘ç”µæœºåŠŸè§’ / Rotor Angle</span>
                    <div class="chart-container" id="img-container-1"></div>
                </div>
                <div class="chart-placeholder">
                    <span class="chart-title">å›¾2: æ¯çº¿ç”µå‹ / Bus Voltage</span>
                    <div class="chart-container" id="img-container-2"></div>
                </div>
                <div class="chart-placeholder">
                    <span class="chart-title">å›¾3: ç³»ç»Ÿé¢‘ç‡ / Frequency</span>
                    <div class="chart-container" id="img-container-3"></div>
                </div>
                <div class="chart-placeholder">
                    <span class="chart-title">å›¾4: å‘ç”µæœºæœ‰åŠŸ / Active Power</span>
                    <div class="chart-container" id="img-container-4"></div>
                </div>
            </div>
        </div>

        <div class="detail-section">
            <div class="section-title">åŸå§‹æ•°æ®æ–‡ä»¶ä¸‹è½½</div>
            <table class="file-list-table">
                <thead>
                    <tr>
                        <th>æ–‡ä»¶ç±»å‹</th>
                        <th>æ–‡ä»¶å</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="d-file-list">
                    </tbody>
            </table>
        </div>
        
    </div>
</div>

<script>
    // ==========================================
    // 1. æ•°æ®æºæ³¨å…¥
    // ==========================================
    const rawData = [
      {
        "final_result": {
          "transKey": "canvas_0_80",
          "fault_start_time": 3.0,
          "cut_time": 3.15,
          "fault_type": 7,
          "voltage_ok": "True",
          "min_voltage": 2.7080039353050064e-11,
          "frequency_ok": "True",
          "max_freq_deviation": 55.3304598070532,
          "power_angle_ok": "True",
          "max_power_angle_diff": 6.212436219154938,
          "minio_path1": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_55_9e6860.png",
          "minio_path2": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_59_15de6a.png",
          "minio_path3": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_53_00_699b67.png",
          "minio_path4": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_53_01_0d1ca5.png"
        },
        "saved_results": {
          "save_flow_emt_hdf5": {
            "flow_url": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/flow_result/2025/12/17/20251217_135110_46cefd7e_pass.h5",
            "emt_url": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/emt_result/2025/12/17/20251217_135110_46cefd7e_pass.h5"
          }
        }
      },
      {
        "final_result": {
          "transKey": "canvas_0_63",
          "fault_start_time": 3.0,
          "cut_time": 3.16,
          "fault_type": 7,
          "voltage_ok": "True",
          "min_voltage": 2.7080039353019988e-11,
          "frequency_ok": "False",
          "max_freq_deviation": 7.134955883519552,
          "power_angle_ok": "True",
          "max_power_angle_diff": 6.212436217030017,
          "minio_path1": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_55_908377.png",
          "minio_path2": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_59_2a8b0d.png",
          "minio_path3": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_53_00_4e5efa.png",
          "minio_path4": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_53_00_20fd38.png"
        },
        "saved_results": {
          "save_flow_emt_hdf5": {
            "flow_url": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/flow_result/2025/12/17/20251217_135110_46cefd7e_pass.h5",
            "emt_url": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/emt_result/2025/12/17/20251217_135110_46cefd7e_pass.h5"
          }
        }
      },
      {
        "final_result": {
          "transKey": "canvas_0_118",
          "fault_start_time": 3.0,
          "cut_time": 3.17,
          "fault_type": 7,
          "voltage_ok": "True",
          "min_voltage": 2.7080039353019988e-11,
          "frequency_ok": "False",
          "max_freq_deviation": 34.7306556136338,
          "power_angle_ok": "True",
          "max_power_angle_diff": 6.212436217168573,
          "minio_path1": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_45_808ed9.png",
          "minio_path2": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_49_cc82e9.png",
          "minio_path3": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_50_cccb1f.png",
          "minio_path4": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/Waveform/2025/12/17/wave_2025_12_17_13_52_51_8c6a93.png"
        },
        "saved_results": {
          "save_flow_emt_hdf5": {
            "flow_url": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/flow_result/2025/12/17/20251217_135110_46cefd7e_pass.h5",
            "emt_url": "http://192.168.130.30:9100/psaagent/IEEE39/n_1/emt_result/2025/12/17/20251217_135110_46cefd7e_pass.h5"
          }
        }
      }
    ];

    // ==========================================
    // 2. è¾…åŠ©å‡½æ•°
    // ==========================================
    const faultTypeMap = {
        7: "ä¸‰ç›¸çŸ­è·¯ (3PH)",
        8: "å•ç›¸æ¥åœ° (1PH-GND)",
        9: "ä¸¤ç›¸çŸ­è·¯ (2PH)",
        "default": "æœªçŸ¥æ•…éšœ"
    };

    function getFaultType(code) {
        return faultTypeMap[code] || `${faultTypeMap['default']} (${code})`;
    }

    function formatNumber(num, unit = '') {
        if (num === null || num === undefined) return '--';
        let val = parseFloat(num);
        if (Math.abs(val) < 0.0001 && val !== 0) {
            return val.toExponential(2) + ' ' + unit; 
        }
        return val.toFixed(4) + ' ' + unit;
    }

    function isOk(strBool) {
        return strBool === "True";
    }

    // ==========================================
    // 3. æ•°æ®å¤„ç†ä¸æ¸²æŸ“
    // ==========================================

    let processedData = [];
    
    // ç­›é€‰çŠ¶æ€ç®¡ç†
    const activeFilters = {
        unstable: false, // æ‰€æœ‰å¼‚å¸¸
        volt: false,     // ç”µå‹è¶Šé™
        freq: false,     // é¢‘ç‡å¤±ç¨³
        angle: false     // åŠŸè§’å¤±ç¨³
    };

    window.onload = function() {
        processData();
        renderKPI();
        renderTable(processedData);
        
        const now = new Date();
        document.getElementById('report-meta').innerText = `æŠ¥å‘Šç”Ÿæˆæ—¶é—´: ${now.toLocaleString()} | è®°å½•æ•°: ${processedData.length}`;
    };

    function processData() {
        processedData = rawData.map((item, index) => {
            const res = item.final_result;
            const files = item.saved_results?.save_flow_emt_hdf5 || {};
            
            let failureModes = [];
            if (!isOk(res.voltage_ok)) failureModes.push('ç”µå‹å¤±ç¨³');
            if (!isOk(res.frequency_ok)) failureModes.push('é¢‘ç‡å¤±ç¨³');
            if (!isOk(res.power_angle_ok)) failureModes.push('åŠŸè§’å¤±ç¨³');
            
            return {
                index: index,
                id: res.transKey,
                faultTypeStr: getFaultType(res.fault_type),
                volt: parseFloat(res.min_voltage),
                freq: parseFloat(res.max_freq_deviation),
                angle: parseFloat(res.max_power_angle_diff),
                
                isVoltOk: isOk(res.voltage_ok),
                isFreqOk: isOk(res.frequency_ok),
                isAngleOk: isOk(res.power_angle_ok),
                isStable: failureModes.length === 0,
                failureModes: failureModes,
                
                timing: { start: res.fault_start_time, cut: res.cut_time },
                images: [res.minio_path1, res.minio_path2, res.minio_path3, res.minio_path4],
                files: files
            };
        });
    }

    function renderKPI() {
        const total = processedData.length;
        const voltFail = processedData.filter(d => !d.isVoltOk).length;
        const freqFail = processedData.filter(d => !d.isFreqOk).length;
        const angleFail = processedData.filter(d => !d.isAngleOk).length;

        document.getElementById('kpi-total').innerText = total;
        document.getElementById('kpi-volt').innerText = voltFail;
        document.getElementById('kpi-freq').innerText = freqFail;
        document.getElementById('kpi-angle').innerText = angleFail;
    }

    function renderTable(data) {
        const tbody = document.getElementById('table-body');
        const emptyState = document.getElementById('empty-state');
        tbody.innerHTML = '';

        if (data.length === 0) {
            emptyState.style.display = 'block';
            return;
        }
        emptyState.style.display = 'none';

        data.forEach(row => {
            const tr = document.createElement('tr');
            
            let statusHtml = '';
            if (row.isStable) {
                statusHtml = '<span class="tag tag-success">âœ… ç³»ç»Ÿç¨³å®š</span>';
            } else {
                statusHtml = row.failureModes.map(m => {
                    let cls = 'tag-warning';
                    if(m.includes('åŠŸè§’') || m.includes('ç”µå‹')) cls = 'tag-error';
                    return `<span class="tag ${cls}">${m}</span>`;
                }).join(' ');
            }

            // é˜ˆå€¼é«˜äº®
            const voltClass = !row.isVoltOk ? 'text-error' : '';
            const freqClass = !row.isFreqOk ? 'text-warning' : '';
            const angleClass = !row.isAngleOk ? 'text-error' : '';

            tr.innerHTML = `
                <td style="font-family:monospace; font-weight:600;">${row.id}</td>
                <td>${row.faultTypeStr}</td>
                <td class="${voltClass}">${formatNumber(row.volt, 'p.u.')}</td>
                <td class="${freqClass}">${formatNumber(row.freq, 'Hz')}</td>
                <td class="${angleClass}">${formatNumber(row.angle, 'Â°')}</td>
                <td>${statusHtml}</td>
                <td><button class="btn btn-primary" style="padding:4px 10px; font-size:12px;" onclick="openDrawer(${row.index}, event)">è¯¦æƒ…</button></td>
            `;
            tr.onclick = () => openDrawer(row.index);
            tbody.appendChild(tr);
        });
    }

    // ==========================================
    // 4. å¢å¼ºç­›é€‰é€»è¾‘ (OR é€»è¾‘)
    // ==========================================

    function toggleFilter(type) {
        // åˆ‡æ¢çŠ¶æ€
        activeFilters[type] = !activeFilters[type];
        
        // æ›´æ–°æŒ‰é’®å¤–è§‚
        const btn = document.getElementById(`filter-${type}`);
        btn.setAttribute('data-active', activeFilters[type]);
        
        applyFilter();
    }

    function applyFilter() {
        const query = document.getElementById('search-box').value.toLowerCase();
        
        // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•è¿‡æ»¤å™¨å¤„äºæ¿€æ´»çŠ¶æ€
        const hasActiveFilters = Object.values(activeFilters).some(v => v);

        const filtered = processedData.filter(item => {
            // 1. æ–‡æœ¬æœç´¢è¿‡æ»¤
            const matchesSearch = item.id.toLowerCase().includes(query);
            if (!matchesSearch) return false;

            // 2. æŒ‰é’®çŠ¶æ€è¿‡æ»¤
            // å¦‚æœæ²¡æœ‰é€‰ä»»ä½•æŒ‰é’®ï¼Œåªçœ‹æœç´¢ç»“æœ
            if (!hasActiveFilters) return true;

            // å¦‚æœé€‰äº†æŒ‰é’®ï¼Œé‡‡ç”¨ OR é€»è¾‘ (æ»¡è¶³ä»»ä¸€é€‰ä¸­æ¡ä»¶å³å¯)
            let matchFilter = false;
            
            if (activeFilters.unstable && !item.isStable) matchFilter = true;
            if (activeFilters.volt && !item.isVoltOk) matchFilter = true;
            if (activeFilters.freq && !item.isFreqOk) matchFilter = true;
            if (activeFilters.angle && !item.isAngleOk) matchFilter = true;

            return matchFilter;
        });

        renderTable(filtered);
    }

    // ==========================================
    // 5. æŠ½å±‰é€»è¾‘
    // ==========================================

    function openDrawer(index, event) {
        if(event) event.stopPropagation();
        const data = processedData[index];
        
        document.getElementById('d-title').innerText = `${data.id} - è¯¦ç»†æŠ¥å‘Š`;
        document.getElementById('d-key').innerText = data.id;
        document.getElementById('d-type').innerText = data.faultTypeStr;
        document.getElementById('d-start-time').innerText = data.timing.start;
        document.getElementById('d-cut-time').innerText = data.timing.cut;

        document.getElementById('d-volt').innerText = formatNumber(data.volt, 'p.u.');
        document.getElementById('d-freq').innerText = formatNumber(data.freq, 'Hz');
        document.getElementById('d-angle').innerText = formatNumber(data.angle, 'deg');
        
        const conclusionEl = document.getElementById('d-conclusion');
        const tagsEl = document.getElementById('d-status-tags');
        
        if (data.isStable) {
            conclusionEl.innerHTML = '<span class="tag tag-success" style="font-size:14px;">æ»¡è¶³ N-1 å‡†åˆ™</span>';
            tagsEl.innerHTML = '<span class="tag tag-success">Stable</span>';
        } else {
            const reasons = data.failureModes.join(' & ');
            conclusionEl.innerHTML = `<span class="tag tag-error" style="font-size:14px;">ä¸æ»¡è¶³: ${reasons}</span>`;
            tagsEl.innerHTML = `<span class="tag tag-error">Unstable</span>`;
        }

        const containers = [
            document.getElementById('img-container-1'),
            document.getElementById('img-container-2'),
            document.getElementById('img-container-3'),
            document.getElementById('img-container-4')
        ];

        data.images.forEach((url, i) => {
            if (i < 4) {
                if (url && url.trim() !== '') {
                    containers[i].innerHTML = `<img src="${url}" alt="Waveform ${i+1}" onerror="this.src='https://via.placeholder.com/800x400?text=Image+Load+Error'">`;
                } else {
                    containers[i].innerHTML = `<span style="color:#ccc">æ— å›¾åƒæ•°æ®</span>`;
                }
            }
        });

        const fileBody = document.getElementById('d-file-list');
        fileBody.innerHTML = '';
        const fileMap = [
            { label: 'æ½®æµè®¡ç®—ç»“æœ (Flow HDF5)', url: data.files.flow_url },
            { label: 'ç”µç£æš‚æ€ç»“æœ (EMT HDF5)', url: data.files.emt_url }
        ];

        fileMap.forEach(f => {
            if (f.url) {
                const fileName = f.url.split('/').pop() || 'download.h5';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${f.label}</td>
                    <td style="word-break:break-all; font-family:monospace; color:#666;">${fileName}</td>
                    <td><a href="${f.url}" class="download-btn" download target="_blank">â¬‡ï¸ ä¸‹è½½</a></td>
                `;
                fileBody.appendChild(tr);
            }
        });

        document.getElementById('overlay').classList.add('open');
        document.getElementById('drawer').classList.add('open');
    }

    function closeDrawer() {
        document.getElementById('overlay').classList.remove('open');
        document.getElementById('drawer').classList.remove('open');
    }
</script>

</body>
</html>