---
name: n-1
type: knowledge
version: 1.0.0
agent: CodeActAgent
triggers:
  - n-1
  - n-1故障
demand_mcp_tool_name: [initModelAndCreateSACanvas,power_flow_sample_simple_ramdom,getCurrentJob,getCurrentConfig,createOrUpdateJob,createOrUpdateConfig,runProject,generate_random_fault_params_set_N_1,setN_1_GroundFault,addComponentOutputMeasures,extract_and_check_data,get_step_temp,get_default_config,submit_batch_simulation,query_batch_simulation_status,get_batch_simulation_result,list_batch_simulation_tasks]
belong_mcp_server: FastMCP
---

# 仿真模式识别与执行规范
  你支持两种仿真模式：
  - **Model A**：单次 N-1 仿真
  - **Model B**：批量 N-1 仿真
  在开始执行仿真前，**必须明确用户希望执行哪种模式**。
  在整个对话中：
  - 仅当用户主动切换时，模式才会改变；
  - 不允许混用 Model A 与 Model B 的工具。
  ---
  ### 执行策略说明
   - **[自动执行]**：立即执行工具，无需等待用户确认
   - **[等待确认]**：执行工具后，必须等待用户确认或提供输入后才能继续下一步
   - **[询问后执行]**：先询问用户意见，根据用户回复决定是否执行，对于所有有明确参数的工具都采取该策略
  ## Model A：单次 N-1 仿真执行流程
  1. **加载模型并初始化**：`[自动执行]`
    创建一个新的仿真画布；
  2. **查看/修改潮流计算任务与参数方案**：`[自动执行 + 等待确认]`
    - 直接执行并以 Markdown 表格的形式输出当前的方案配置，禁止使用任何代码块（```）包裹表格。
    - **暂停点**：输出后询问用户是否需要进行修改
	- 等待用户回复后：
		- 若用户要求修改，根据用户的输入进行修改
		- 用户无需修改，直接进行下一步
  3. **生成随机潮流样本并执行潮流计算**: `[询问后执行]`
  4. **生成或请求 N-1 故障参数**：`[询问后执行]`
    - **暂停点**：询问用户是随机生成 N-1 参数还是自定义输入，并根据用户的决定选择相应的工具
  5. **查看/修改电磁暂态计算任务与参数方案**：`[自动执行 + 等待确认]`
    - 直接执行并以 Markdown 表格的形式输出当前的方案配置，禁止使用任何代码块（```）包裹表格。
    - **暂停点**：输出后询问用户是否需要进行修改
	- 等待用户回复后：
		- 若用户要求修改，根据用户的输入进行修改
		- 用户无需修改，直接进行下一步
  6. **添加量测信号（必须严格按顺序）**: `[询问后执行]`
    - 母线电压（rid:`model/CloudPSS/_newBus_3p`, key:`Vrms`）
    - 发电机功率（rid:`model/CloudPSS/SyncGeneratorRouter`, key:`PT_o`）
    - 发电机转速（rid:`model/CloudPSS/SyncGeneratorRouter`, key:`wr_o`）
    - 发电机攻角（rid:`model/CloudPSS/SyncGeneratorRouter`, key:`theta_o`）
    - 向用户说明上述需要添加的量测，并询问是否需要修改
    - 注意：你需为每个量测定义一个合适的绘图名称。其余参数均使用默认值，不要额外设置，特别是dim参数
  7. **执行仿真**：`[询问后执行]`
  8. **结果分析与输出**：`[自动执行]`
   - 检查电压、频率、攻角的稳定性；
   - 对于生成的每个结果图片（存储于 MinIO），需使用 Markdown 图片语法(![]()) 输出；
   - 禁止在代码块中输出图片链接；确保前端能直接渲染显示图片
  ---
  ## Model B：批量 N-1 仿真执行流程

  ### 重要约束
  - **禁止**在 Model B 中调用任何单次仿真（Model A）的工具，特别是关于方案修改的
  - **禁止**直接执行仿真计算，仅可配置、提交批量任务

  ---

  ### 步骤流程

  **步骤 1：查看默认参数方案与计算方案** `[自动执行 + 等待确认]`
  - 获取当前默认配置并以 Markdown 表格形式展示（禁止使用代码块包裹）
  - 等待用户回复后：
    - 若用户要求修改 → **仅记录修改意图**（不执行实际修改，批量配置将在步骤4统一处理）
    - 若用户确认无需修改 → 自动进入步骤 2

  ---

  **步骤 2：确认单次仿真流程模板** `[自动执行 + 等待确认]`
    1. 获取用于单次仿真的流程模板和涉及的工具列表
    2. 以清晰的列表形式展示调整后的流程
  - 等待用户回复后：
    - 若用户要求调整 → 根据用户需求调整流程，调整后再次向用户确认
    - 若用户确认流程无误 → 自动进入步骤 3

  ---

  **步骤 3：工具参数说明与配置确认** `[自动执行 + 等待确认]`
  - 操作：
    - **仅解释**流程中每个工具的参数（参数名称、类型、取值范围、默认值）
    - **不执行**任何工具
    - **不推理**结果或生成仿真输出
  - 等待用户回复后：
    - **仅记录**用户的参数配置意图
    - 自动进入步骤 4

  ---

  **步骤 4：生成批量配置 JSON** `[自动执行 + 等待确认]`
  - 操作：根据前面步骤收集的信息，生成批量仿真配置 JSON

  #### 配置结构规范：

  1. **基本结构**：
     ```json
     {
       "steps": [
         {
           "name": "工具名称",
           "params": { "参数名": "参数值或配置对象" }
         }
       ],
       "zip": [["工具1.参数1", "工具2.参数2"]]  // 可选，参数绑定
     }
     ```

  2. **参数取值方式**：
     - **固定值**：直接赋值： "case_name": "IEEE14"
     - **choices（枚举）**：从列表中逐一选择："iterations": {"choices": [5, 10, 15]}
     - **range（范围）**：按步长遍历："voltage": {"range": {"start": 0.9, "end": 1.1, "step": 0.05}}
     - **random（随机）**：在范围内随机采样："load_factor": {"random": {"low": 0.8, "high": 1.2, "count": 10}}

     - **zip（绑定）**：多个参数一一对应遍历："zip": [["fault_analysis.fault_bus", "fault_analysis.fault_type"]]
       - **仅在**用户明确说明参数间存在一一对应关系时使用
       - **禁止**用于长度不匹配或独立变化的参数
       - **禁止**在 `params` 内部使用，必须放在与 `steps` 同级

  3. **特殊规则**：
     - 若参数本身是列表（如 `bus_list = [1,2,3]`），保持为普通列表，不展开
     - 输出必须为**纯 JSON 格式**，不添加注释或解释文字

  4. **配置示例**：

     用户需求：
     - `load_data` 的 `case_name` 固定为 `"IEEE14"`
     - `run_power_flow` 的 `iterations` 从 5 到 15，步长 5
     - `fault_analysis` 的 `fault_bus` 从 `[1, 2, 3]` 中选择，`fault_type` 从 `['a','b','c']` 中选择，两个参数一一对应
     - `output_channel` 的 `channels` 固定为 `["voltage", "angle"]`

     生成配置：
     ```json
     {
       "steps": [
         {
           "name": "load_data",
           "params": {"case_name": "IEEE14"}
         },
         {
           "name": "run_power_flow",
           "params": {"iterations": {"range": {"start": 5, "end": 15, "step": 5}}}
         },
         {
           "name": "fault_analysis",
           "params": {
             "fault_bus": {"choices": [1, 2, 3]},
             "fault_type": {"choices": ["a", "b", "c"]}
           }
         },
         {
           "name": "output_channel",
           "params": {"channels": ["voltage", "angle"]}
         }
       ],
       "zip": [["fault_analysis.fault_bus", "fault_analysis.fault_type"]]
     }
     ```

  - 等待用户回复后：
    - 若用户要求修改 → 根据反馈修改配置，再次确认
    - 若用户确认无误 → 自动进入步骤 5

  ---

  **步骤 5：参数检查与批量次数确认** `[自动执行 + 等待确认]`
  - 操作：
    - 检查配置中是否使用了 `choices`、`range` 或 `random`
    - 如果**所有参数均为固定值**，需要用户指定批量仿真次数
  - 等待用户回复后：自动进入步骤 6

  ---

  **步骤 6：提交批量仿真任务** `[询问后执行]`
  - 等待用户确认提交后：
    - 用户确认 → 提交任务并返回任务 ID
    - 提交成功后，告知用户任务 ID 并说明可使用工具查询任务状态、获取仿真结果、查看所有任务
  - 自动进入步骤 7

  ---

  **步骤 7：结果查询与结构化输出** `[询问后执行]`
  - 由用户主动发起查询请求，默认不进行轮询,只要仿真处于完成状态，不论失败还是成功，都应理解获取结果
  - 输出规范：
    - **图片链接**必须使用 Markdown 图片语法（![]()），禁止代码块包裹
    - **结果汇总**以表格形式输出，包含：
      - 仿真序号
      - 结果图片（嵌入表格）
      - 稳定性判断
    - 多次仿真结果合并在一个表格中
  - 流程结束
